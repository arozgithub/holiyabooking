<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Service</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .page.active {
            display: block;
        }

        /* Services Page */
        .services-header {
            text-align: center;
            padding: 40px 20px;
            background: white;
        }

        .services-header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            color: #333;
            margin-bottom: 10px;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            padding: 40px;
            background: white;
        }

        .service-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .service-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .service-image {
            width: 100%;
            height: 250px;
            background-color: #f0f0f0;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .therapeutic-massage {
            background-image: url('https://static.wixstatic.com/media/11062b_5e931d19ca3b400e9d4132a683a3910c~mv2.jpg/v1/fill/w_523,h_350,fp_0.50_0.50,lg_1,q_80,enc_auto/11062b_5e931d19ca3b400e9d4132a683a3910c~mv2.jpg');
        }

        .acupuncture {
            background-image: url('https://static.wixstatic.com/media/e57c4e4d1e1846b2a87e187bea63af7f.jpg/v1/fill/w_523,h_350,fp_0.50_0.50,q_80,usm_0.66_1.00_0.01,enc_auto/e57c4e4d1e1846b2a87e187bea63af7f.jpg');
        }

        .pelvic-floor {
            background-image: url('https://static.wixstatic.com/media/5e8fbf2d57fe41118ebe959cf4857f7c.png/v1/fill/w_523,h_350,fp_0.50_0.50,q_85,usm_0.66_1.00_0.01,enc_auto/5e8fbf2d57fe41118ebe959cf4857f7c.png');
        }

        .service-info {
            padding: 25px;
        }

        .service-info h3 {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .service-duration {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .book-btn {
            background: #B8860B;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
            text-transform: uppercase;
            font-weight: 500;
        }

        .book-btn:hover {
            background: #996F00;
        }

        /* Calendar Page */
        .calendar-header {
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            color: #333;
        }

        .calendar-title {
            flex: 1;
        }

        .calendar-title h1 {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 5px;
            font-weight: 400;
        }

        .calendar-title p {
            color: #666;
            font-size: 0.9rem;
        }

        .calendar-content {
            display: grid;
            grid-template-columns: 1fr 1fr 300px;
            min-height: 700px;
        }

        .calendar-left {
            padding: 40px;
            border-right: 1px solid #e0e0e0;
        }

        .filter-section {
            margin-bottom: 30px;
        }

        .filter-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .filter-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .date-time-section h3 {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .timezone-info {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: #f0f0f0;
            border-radius: 4px;
        }

        .month-year {
            font-size: 1.1rem;
            color: #333;
        }

        .day-header {
            background: #f8f8f8;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        .day-cell {
            background: white;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .day-cell:hover {
            background: #f0f0f0;
        }

        .day-cell.today {
            background: #B8860B;
            color: white;
            font-weight: bold;
        }

        .day-cell.other-month {
            color: #ccc;
        }

        .day-cell.selected {
            background: #B8860B;
            color: white;
            font-weight: bold;
        }

        .day-cell.disabled {
            color: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .calendar-right {
            padding: 40px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .availability-section h4 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .no-availability {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .time-slot {
            padding: 10px 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .time-slot:hover {
            background: #f0f0f0;
            border-color: #B8860B;
        }

        .time-slot.selected {
            background: #B8860B;
            color: white;
            border-color: #B8860B;
        }

        .service-details {
            padding: 40px;
            background: #f9f9f9;
        }

        .service-details h4 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .service-name {
            font-size: 1.2rem;
            color: #333;
            font-weight: 500;
        }

        .next-btn {
            background: #ccc;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: not-allowed;
            margin-top: 30px;
            width: 100%;
        }

        .next-btn.active {
            background: #333;
            cursor: pointer;
        }

        /* Booking Form Page */
        .booking-form-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            min-height: 600px;
        }

        .form-left {
            padding: 40px;
        }

        .form-right {
            padding: 40px;
            background: #f9f9f9;
            border-left: 1px solid #e0e0e0;
        }

        .client-details h2 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 5px;
        }

        .required {
            color: #e74c3c;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #B8860B;
        }

        .message-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
        }

        .booking-details h3 {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .booking-summary {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .booking-summary p {
            margin-bottom: 8px;
            color: #666;
        }

        .booking-summary strong {
            color: #333;
        }

        .final-book-btn {
            width: 100%;
            padding: 15px;
            background: #B8860B;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 500;
        }

        .final-book-btn:hover {
            background: #996F00;
        }

        .final-book-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .services-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .calendar-content {
                grid-template-columns: 1fr;
                height: auto;
            }

            .calendar-right, .service-details {
                border-right: none;
                border-top: 1px solid #e0e0e0;
            }

            .booking-form-content {
                grid-template-columns: 1fr;
            }

            .calendar-header {
                padding: 15px 20px;
            }

            .calendar-left, .calendar-right, .service-details {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Services Selection Page -->
        <div class="page active" id="services-page">
            <div class="services-header">
                <h1>PMS Practitioners</h1>
            </div>
            <div class="services-grid">
                <div class="service-card" data-service="Therapeutic Massage">
                    <div class="service-image therapeutic-massage"></div>
                    <div class="service-info">
                        <h3>Therapeutic Massage</h3>
                        <div class="service-duration">1 hr</div>
                        <button class="book-btn">Book Now</button>
                    </div>
                </div>

                <div class="service-card" data-service="Acupuncture">
                    <div class="service-image acupuncture"></div>
                    <div class="service-info">
                        <h3>Acupuncture</h3>
                        <div class="service-duration">1 hr</div>
                        <button class="book-btn">Book Now</button>
                    </div>
                </div>

                <div class="service-card" data-service="Pelvic Floor Therapy">
                    <div class="service-image pelvic-floor"></div>
                    <div class="service-info">
                        <h3>Pelvic Floor Therapy</h3>
                        <div class="service-duration">1 hr</div>
                        <button class="book-btn">Book Now</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div class="page" id="calendar-page">
            <div class="calendar-header">
                <button class="back-btn" onclick="goToServices()">
                    <span>←</span> Back
                </button>
                <div class="calendar-title">
                    <h1>Schedule your service</h1>
                    <p>Check out our availability and book the date and time that works for you</p>
                </div>
            </div>

            <div class="calendar-content">
                <div class="calendar-left">
                    <div class="filter-section">
                        <div class="filter-label">Select Healthcare Provider:</div>
                        <select class="filter-select" id="practitioner-filter">
                            <option value="">Please select a provider</option>
                        </select>
                    </div>

                    <div class="date-time-section">
                        <h3>Select a Date and Time</h3>
                        <div class="timezone-info" id="timezone-info">Loading timezone...</div>
                        
                        <div class="calendar-nav">
                            <button class="nav-btn" onclick="previousMonth()">←</button>
                            <div class="month-year" id="month-year"></div>
                            <button class="nav-btn" onclick="nextMonth()">→</button>
                        </div>

                        <div class="calendar-grid" id="calendar-grid">
                            <div class="day-header">Mon</div>
                            <div class="day-header">Tue</div>
                            <div class="day-header">Wed</div>
                            <div class="day-header">Thu</div>
                            <div class="day-header">Fri</div>
                            <div class="day-header">Sat</div>
                            <div class="day-header">Sun</div>
                        </div>
                    </div>
                </div>

                <div class="calendar-right">
                    <div class="availability-section">
                        <h4 id="availability-header">Select a provider and date</h4>
                        <div id="availability-content">
                            <div class="no-availability">Please select a healthcare provider first</div>
                        </div>
                    </div>
                </div>

                <div class="service-details">
                    <h4>Service Details</h4>
                    <div class="service-name" id="selected-service-name">Please select a service</div>
                    <button class="next-btn" id="next-btn" onclick="goToBookingForm()">Next</button>
                </div>
            </div>
        </div>

        <!-- Booking Form Page -->
        <div class="page" id="booking-form-page">
            <div class="calendar-header">
                <button class="back-btn" onclick="goToCalendar()">
                    <span>←</span> Back
                </button>
            </div>

            <div class="booking-form-content">
                <div class="form-left">
                    <div class="client-details">
                        <h2>Client Details</h2>

                        <form id="booking-form">
                            <div class="form-group">
                                <label class="form-label">Full Name <span class="required">*</span></label>
                                <input type="text" class="form-input" id="full-name" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Email <span class="required">*</span></label>
                                <input type="email" class="form-input" id="email" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Questions & Concerns</label>
                                <textarea class="message-textarea" id="questions" placeholder="Any questions or concerns..."></textarea>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="form-right">
                    <div class="booking-details">
                        <h3>Booking Details</h3>
                        <div class="booking-summary">
                            <p><strong>Service:</strong> <span id="booking-service">-</span></p>
                            <p><strong>Provider:</strong> <span id="booking-provider">-</span></p>
                            <p><strong>Date & Time:</strong> <span id="booking-datetime">-</span></p>
                        </div>

                        <button class="final-book-btn" onclick="finalizeBooking()">Book Appointment</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">Processing your booking...</div>
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_CALENDAR_API_KEY: 'AIzaSyBpWZVSkG5zaX-UGTQqxuLBoYXsMps1ers',
            GOOGLE_SHEETS_API_KEY: 'AIzaSyB2IMFP4CtxJoRT5x-rKycbBvOL5u2BnO4',
            PRACTITIONERS_SHEET_ID: '1gwp8NgBtY-pQh--jeHmwU_lns4YtNF3Q6xdBYhC5urQ',
            CALENDAR_IDS_SHEET_ID: '1uXWH0Vr1R68JLR4SL_oZokCj20VaJwhPb7lvD-QVyJg',
            ADMIN_WEBHOOK: 'https://holiya.app.n8n.cloud/webhook/Booking_Email',
            PATIENT_WEBHOOK: 'https://holiya.app.n8n.cloud/webhook/Notify_Patient',
            BOOK_APPOINTMENT_WEBHOOK: 'https://holiya.app.n8n.cloud/webhook/Book_Appointment',
            ENTER_PATIENT_DATA_WEBHOOK: 'https://holiya.app.n8n.cloud/webhook/Enter_Patient_Data'
        };

        // Global state
        let selectedService = '';
        let selectedPractitioner = '';
        let selectedPractitionerCalendarId = '';
        let selectedDate = null;
        let selectedTime = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let practitioners = [];
        let calendarIds = {};
        let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        let gapi_loaded = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            detectTimezone();
            loadPractitioners();
            setupServiceCards();
            renderCalendar();
        });

        function detectTimezone() {
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const date = new Date();
            const timezoneName = date.toLocaleDateString('en-US', { timeZoneName: 'short' }).split(', ')[1];
            document.getElementById('timezone-info').textContent = `Time zone: ${timezoneName} (${timezone})`;
        }

        function setupServiceCards() {
            document.querySelectorAll('.service-card').forEach(card => {
                card.querySelector('.book-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectedService = card.dataset.service;
                    document.getElementById('selected-service-name').textContent = card.querySelector('h3').textContent;
                    document.getElementById('booking-service').textContent = card.querySelector('h3').textContent;
                    goToCalendar();
                });
            });
        }

        async function loadPractitioners() {
            try {
                // Load practitioners
                const practitionersResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.PRACTITIONERS_SHEET_ID}/values/Sheet1?key=${CONFIG.GOOGLE_SHEETS_API_KEY}`
                );
                
                if (!practitionersResponse.ok) throw new Error('Failed to load practitioners');
                
                const practitionersData = await practitionersResponse.json();
                if (practitionersData.values && practitionersData.values.length > 1) {
                    practitioners = practitionersData.values.slice(1); // Skip header row
                }
                
                // Load calendar IDs
                const calendarResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.CALENDAR_IDS_SHEET_ID}/values/Sheet1?key=${CONFIG.GOOGLE_SHEETS_API_KEY}`
                );
                
                if (calendarResponse.ok) {
                    const calendarData = await calendarResponse.json();
                    if (calendarData.values && calendarData.values.length > 1) {
                        calendarData.values.slice(1).forEach(row => {
                            if (row[0] && row[1]) { // Calendar Name and ID columns
                                calendarIds[row[0]] = row[1];
                            }
                        });
                    }
                }
                
                console.log('Loaded practitioners:', practitioners);
                console.log('Loaded calendar IDs:', calendarIds);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load practitioners. Please refresh the page.');
            }
        }

        function populatePractitionerFilter() {
            const filter = document.getElementById('practitioner-filter');
            filter.innerHTML = '<option value="">Please select a provider</option>';
            
            // Filter practitioners by selected service
            const matchingPractitioners = practitioners.filter(practitioner => {
                const [fullName, service] = practitioner;
                return fullName && service && service.trim() === selectedService;
            });

            console.log('Matching practitioners for', selectedService, ':', matchingPractitioners);
            
            matchingPractitioners.forEach(practitioner => {
                const [fullName] = practitioner;
                const option = document.createElement('option');
                option.value = fullName;
                option.textContent = fullName;
                filter.appendChild(option);
            });

            filter.addEventListener('change', function() {
                selectedPractitioner = this.value;
                selectedPractitionerCalendarId = calendarIds[selectedPractitioner];
                console.log('Selected practitioner:', selectedPractitioner, 'Calendar ID:', selectedPractitionerCalendarId);
                
                if (selectedPractitioner) {
                    document.getElementById('booking-provider').textContent = selectedPractitioner;
                    updateAvailabilityHeader();
                    if (selectedDate) {
                        checkAvailability(selectedDate);
                    }
                } else {
                    document.getElementById('availability-content').innerHTML = '<div class="no-availability">Please select a healthcare provider first</div>';
                }
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthYear = document.getElementById('month-year');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear existing days
            const existingDays = grid.querySelectorAll('.day-cell');
            existingDays.forEach(day => day.remove());
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Get first Monday of the calendar view
            const startDate = new Date(firstDay);
            const dayOfWeek = firstDay.getDay();
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDate.setDate(firstDay.getDate() - daysToSubtract);
            
            // Generate 42 days (6 weeks)
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.textContent = currentDate.getDate();
                
                if (currentDate.getMonth() !== currentMonth) {
                    dayCell.classList.add('other-month');
                }
                
                const currentDateOnly = new Date(currentDate);
                currentDateOnly.setHours(0, 0, 0, 0);
                
                if (currentDateOnly.getTime() === today.getTime()) {
                    dayCell.classList.add('today');
                }
                
                // Only allow future dates (including today)
                if (currentDateOnly >= today) {
                    dayCell.addEventListener('click', function() {
                        selectDate(currentDate, this);
                    });
                } else {
                    dayCell.classList.add('disabled');
                }
                
                grid.appendChild(dayCell);
            }
        }

        function selectDate(date, element) {
            if (!selectedPractitioner) {
                alert('Please select a healthcare provider first');
                return;
            }

            document.querySelectorAll('.day-cell.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedDate = new Date(date);
            
            updateAvailabilityHeader();
            checkAvailability(date);
        }

        function updateAvailabilityHeader() {
            if (!selectedDate) {
                document.getElementById('availability-header').textContent = 'Select a date';
                return;
            }

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const dayName = dayNames[selectedDate.getDay()];
            const day = selectedDate.getDate();
            const month = monthNames[selectedDate.getMonth()];
            
            document.getElementById('availability-header').textContent = 
                `Availability for ${dayName} ${day} ${month}`;
        }

        async function checkAvailability(date) {
            if (!selectedPractitionerCalendarId) {
                document.getElementById('availability-content').innerHTML = 
                    '<div class="no-availability">Please select a healthcare provider first</div>';
                return;
            }

            const availabilityContent = document.getElementById('availability-content');
            availabilityContent.innerHTML = '<div class="loading">Checking availability...</div>';
            
            try {
                const availableSlots = await findAvailableSlots(date);
                
                if (availableSlots.length > 0) {
                    displayTimeSlots(availableSlots);
                } else {
                    availabilityContent.innerHTML = '<div class="no-availability">No availability for this date</div>';
                }
                
            } catch (error) {
                console.error('Error checking availability:', error);
                availabilityContent.innerHTML = '<div class="no-availability">Error checking availability</div>';
            }
        }

        async function findAvailableSlots(date) {
            if (!selectedPractitionerCalendarId) {
                return [];
            }
            
            const availableSlots = [];
            const startHour = 8; // 8 AM
            const endHour = 17; // 5 PM
            
            // Create date in user's timezone
            const baseDate = new Date(date);
            baseDate.setHours(0, 0, 0, 0);
            
            for (let hour = startHour; hour < endHour; hour++) {
                const slotTime = new Date(baseDate);
                slotTime.setHours(hour, 0, 0, 0);
                
                // Skip past times for today
                if (slotTime <= new Date()) continue;
                
                const isAvailable = await checkTimeSlotAvailability(slotTime);
                if (isAvailable) {
                    availableSlots.push(slotTime);
                }
            }
            
            return availableSlots;
        }

        async function checkTimeSlotAvailability(dateTime) {
            try {
                const startTime = dateTime.toISOString();
                const endTime = new Date(dateTime.getTime() + 60 * 60 * 1000).toISOString();
                
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(selectedPractitionerCalendarId)}/events?key=${CONFIG.GOOGLE_CALENDAR_API_KEY}&timeMin=${startTime}&timeMax=${endTime}&singleEvents=true`
                );
                
                if (!response.ok) {
                    console.error('Calendar API error:', response.status, response.statusText);
                    return false;
                }
                
                const data = await response.json();
                return data.items.length === 0;
                
            } catch (error) {
                console.error('Error checking time slot:', error);
                return false;
            }
        }

        function displayTimeSlots(slots) {
            const availabilityContent = document.getElementById('availability-content');
            
            if (slots.length === 0) {
                availabilityContent.innerHTML = '<div class="no-availability">No available times</div>';
                return;
            }
            
            const timeSlotsDiv = document.createElement('div');
            timeSlotsDiv.className = 'time-slots';
            
            slots.forEach(slot => {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.textContent = slot.toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                timeSlot.addEventListener('click', function() {
                    selectTimeSlot(slot, this);
                });
                
                timeSlotsDiv.appendChild(timeSlot);
            });
            
            availabilityContent.innerHTML = '';
            availabilityContent.appendChild(timeSlotsDiv);
        }

        function selectTimeSlot(slot, element) {
            document.querySelectorAll('.time-slot.selected').forEach(timeSlot => {
                timeSlot.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedTime = new Date(slot);
            
            // Update booking details
            updateBookingDateTime();
            
            // Enable next button
            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.add('active');
            nextBtn.style.cursor = 'pointer';
            nextBtn.style.background = '#333';
        }

        function updateBookingDateTime() {
            if (selectedTime) {
                const options = {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                
                const formattedDateTime = selectedTime.toLocaleDateString('en-GB', options);
                document.getElementById('booking-datetime').textContent = formattedDateTime;
            }
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // Navigation functions
        function goToServices() {
            showPage('services-page');
            resetSelections();
        }

        function goToCalendar() {
            showPage('calendar-page');
            populatePractitionerFilter();
        }

        function goToBookingForm() {
            if (!selectedTime) {
                alert('Please select a time slot');
                return;
            }
            showPage('booking-form-page');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function resetSelections() {
            selectedService = '';
            selectedPractitioner = '';
            selectedPractitionerCalendarId = '';
            selectedDate = null;
            selectedTime = null;
            
            document.querySelectorAll('.selected').forEach(element => {
                element.classList.remove('selected');
            });
            
            const nextBtn = document.getElementById('next-btn');
            nextBtn.classList.remove('active');
            nextBtn.style.cursor = 'not-allowed';
            nextBtn.style.background = '#ccc';
            
            // Reset booking details
            document.getElementById('booking-service').textContent = '-';
            document.getElementById('booking-provider').textContent = '-';
            document.getElementById('booking-datetime').textContent = '-';
        }

        async function finalizeBooking() {
            const fullName = document.getElementById('full-name').value.trim();
            const email = document.getElementById('email').value.trim();
            const questions = document.getElementById('questions').value.trim();

            console.log('Starting finalizeBooking...', {
                fullName,
                email,
                selectedService,
                selectedPractitioner,
                selectedPractitionerCalendarId,
                selectedTime
            });

            if (!fullName || !email) {
                alert('Please fill in all required fields');
                return;
            }

            if (!selectedTime || !selectedPractitioner) {
                alert('Please select a time slot and practitioner');
                return;
            }

            if (!selectedPractitionerCalendarId) {
                alert('Calendar ID not found for selected practitioner');
                console.error('Missing calendar ID for practitioner:', selectedPractitioner);
                return;
            }

            // Disable button and show loading
            const bookBtn = document.querySelector('.final-book-btn');
            bookBtn.disabled = true;
            bookBtn.textContent = 'Processing...';
            document.getElementById('loading').style.display = 'block';
            
            try {
                console.log('Creating calendar appointment...');
                
                // Create calendar appointment via n8n webhook
                const appointmentResult = await createCalendarAppointment(fullName, email, questions);
                console.log('Appointment result:', appointmentResult);
                
                if (appointmentResult.success) {
                    console.log('Calendar appointment successful, saving patient details...');
                    
                    // Save patient details via n8n webhook
                    await savePatientDetailsViaWebhook(fullName, email, questions);
                    console.log('Patient details saved, sending notifications...');
                    
                    // Send notifications via webhooks
                    await sendNotifications(fullName, email, questions);
                    console.log('Notifications sent, showing success...');
                    
                    // Show success
                    showSuccess(fullName);
                } else {
                    console.error('Appointment creation failed:', appointmentResult.error);
                    throw new Error(appointmentResult.error || 'Failed to create calendar appointment');
                }
                
            } catch (error) {
                console.error('Booking error details:', {
                    message: error.message,
                    stack: error.stack,
                    selectedPractitioner,
                    selectedPractitionerCalendarId,
                    selectedTime
                });
                showError(`Failed to create appointment: ${error.message}`);
                bookBtn.disabled = false;
                bookBtn.textContent = 'Book Appointment';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function createCalendarAppointment(fullName, email, questions) {
            try {
                console.log('Creating calendar appointment...');
                console.log('Selected practitioner calendar ID:', selectedPractitionerCalendarId);
                console.log('Selected time:', selectedTime);

                if (!selectedPractitionerCalendarId) {
                    throw new Error('No calendar ID found for selected practitioner');
                }

                const endTime = new Date(selectedTime.getTime() + 60 * 60 * 1000); // 1 hour appointment

                const appointmentData = {
                    calendarId: selectedPractitionerCalendarId,
                    startTime: selectedTime.toISOString(),
                    endTime: endTime.toISOString(),
                    summary: `${selectedService} - ${fullName}`,
                    description: `Patient: ${fullName}\nEmail: ${email}\nService: ${selectedService}\nProvider: ${selectedPractitioner}\nQuestions/Concerns: ${questions || 'None'}`,
                    attendeeEmail: email,
                    attendeeName: fullName,
                    timeZone: userTimezone
                };

                console.log('Sending appointment data to webhook:', appointmentData);
                console.log('Webhook URL:', CONFIG.BOOK_APPOINTMENT_WEBHOOK);

                const response = await fetch(CONFIG.BOOK_APPOINTMENT_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    body: JSON.stringify(appointmentData)
                });

                console.log('Webhook response status:', response.status);
                console.log('Webhook response headers:', Object.fromEntries(response.headers));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Webhook error response:', errorText);
                    throw new Error(`Webhook request failed: ${response.status} - ${errorText}`);
                }

                const responseText = await response.text();
                console.log('Raw webhook response:', responseText);

                // Check if workflow completed successfully
                if (responseText.trim() === 'Workflow Completed!' || responseText.includes('Workflow Completed!')) {
                    console.log('Webhook successful - workflow completed');
                    return { success: true };
                } else {
                    console.warn('Unexpected webhook response:', responseText);
                    return { success: false, error: `Unexpected webhook response: ${responseText}` };
                }

            } catch (error) {
                console.error('Error in createCalendarAppointment:', error);
                
                // More specific error handling for CORS and network issues
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    return { 
                        success: false, 
                        error: 'Network error: Cannot reach webhook. This is likely a CORS issue - the n8n webhook needs to allow requests from this domain.' 
                    };
                }
                
                return { success: false, error: error.message };
            }
        }

        async function savePatientDetailsViaWebhook(fullName, email, questions) {
            try {
                const formattedDateTime = selectedTime.toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

                const patientData = {
                    patientName: fullName,
                    email: email,
                    questionsAndConcerns: questions || '',
                    time: formattedDateTime,
                    healthcareProviderName: selectedPractitioner,
                    service: selectedService
                };

                console.log('Sending patient data to n8n webhook:', patientData);
                console.log('Webhook URL:', CONFIG.ENTER_PATIENT_DATA_WEBHOOK);

                const response = await fetch(CONFIG.ENTER_PATIENT_DATA_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                        'Origin': window.location.origin
                    },
                    mode: 'cors',
                    body: JSON.stringify(patientData)
                });

                console.log('Patient data webhook response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Patient data webhook error response:', errorText);
                    throw new Error(`Patient data webhook failed: ${response.status} - ${errorText}`);
                }

                const responseText = await response.text();
                console.log('Patient data webhook response:', responseText);

                // Check if workflow completed successfully
                if (responseText.trim() === 'Workflow Completed!' || responseText.includes('Workflow Completed!')) {
                    console.log('Patient data webhook successful - workflow completed');
                    return { success: true };
                } else {
                    console.warn('Unexpected patient data webhook response:', responseText);
                    // Don't throw error here as the appointment was already created
                    return { success: false, error: `Unexpected response: ${responseText}` };
                }

            } catch (error) {
                console.error('Error saving patient details via webhook:', error);
                // Don't throw error here as the appointment was already created
                console.warn('Patient details saving failed, but appointment was created successfully');
                return { success: false, error: error.message };
            }
        }

        async function sendNotifications(fullName, email, questions) {
            const appointmentData = {
                patientName: fullName,
                patientEmail: email,
                service: selectedService,
                provider: selectedPractitioner,
                dateTime: selectedTime.toLocaleString('en-GB', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }),
                questions: questions || 'None',
                timezone: userTimezone
            };

            try {
                // Send admin notification
                const adminResponse = await fetch(CONFIG.ADMIN_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(appointmentData)
                });

                if (!adminResponse.ok) {
                    console.error('Failed to send admin notification:', adminResponse.status);
                }

                // Send patient notification
                const patientResponse = await fetch(CONFIG.PATIENT_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(appointmentData)
                });

                if (!patientResponse.ok) {
                    console.error('Failed to send patient notification:', patientResponse.status);
                }

                console.log('Notifications sent successfully');

            } catch (error) {
                console.error('Error sending notifications:', error);
                // Don't throw error here as the booking is still valid
            }
        }

        function showSuccess(patientName) {
            const serviceName = document.getElementById('selected-service-name').textContent;
            const formattedDateTime = selectedTime.toLocaleString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            document.getElementById('success-message').innerHTML = `
                <h3>Appointment Booked Successfully!</h3>
                <p><strong>Patient:</strong> ${patientName}</p>
                <p><strong>Service:</strong> ${serviceName}</p>
                <p><strong>Provider:</strong> ${selectedPractitioner}</p>
                <p><strong>Date & Time:</strong> ${formattedDateTime}</p>
                <br>
                <p>Your appointment has been added to the provider's calendar.</p>
                <p>Please check your email for confirmation details.</p>
                <p>Our team will contact you soon.</p>
                <br>
                <button class="final-book-btn" onclick="resetAndGoHome()" style="margin-top: 15px;">Book Another Appointment</button>
            `;
            document.getElementById('success-message').style.display = 'block';
            
            // Hide the booking form
            document.querySelector('.booking-form-content').style.display = 'none';
        }

        function showError(message) {
            console.error('Showing error:', message);
            document.getElementById('error-message').innerHTML = `
                <strong>Booking Error:</strong><br>
                ${message}<br>
                <small>Check the browser console (F12) for detailed error information.</small>
            `;
            document.getElementById('error-message').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('error-message').style.display = 'none';
            }, 10000); // Show for 10 seconds
        }

        function resetAndGoHome() {
            // Reset all form fields
            document.querySelectorAll('input, textarea').forEach(field => {
                field.value = '';
            });
            
            // Reset success message
            document.getElementById('success-message').style.display = 'none';
            document.querySelector('.booking-form-content').style.display = 'grid';
            
            // Reset book button
            const bookBtn = document.querySelector('.final-book-btn');
            bookBtn.disabled = false;
            bookBtn.textContent = 'Book Appointment';
            
            // Go back to services
            resetSelections();
            goToServices();
        }
    </script>
</body>
</html>
